# SANDY SYSTEM ARCHITECTURE (Hybrid "Hard Rails" Model)

## 1. System Philosophy: Brain vs. Hands

This architecture implements a **Hybrid Model** to strictly prevent LLM hallucinations. It separates the system into two distinct operational modes:

* **The Brain (Sandy / AGENTS.md):** The LLM acting as the Orchestrator. It plans workflows, delegates tasks, and converses with the user. It **cannot** directly interact with the world (web/files) except through specific tools.
* **The Hands (Scripts / Skills):** Deterministic, hardcoded Python/Bash scripts that execute actions. These scripts succeed or fail based on code, not probability.
* **The Truth (File System):** The file system (specifically `/mnt/storage` or `./storage`) is the **only** source of truth. If data is not saved to a file, it effectively does not exist.

---

## 2. Directory Structure & Overview

This is the concrete file structure implemented on the Raspberry Pi.

```text
/root/openclaw/ (or ./project_root)
├── AGENTS.md                 # CORE: Operational rules & delegation protocols
├── TOOLS.md                  # CORE: The definitive list of available, hardcoded tools
├── SOUL.md                   # CORE: Personality, tone, and "vibes"
├── prompts/
│   └── guard_rails.txt       # DNA: Safety rules injected into EVERY spawned agent
├── src/
│   ├── skills/               # CAPABILITIES: Modular skill packages
│   │   ├── journalistic-research/
│   │   │   ├── SKILL.md      # Metadata: When to use this skill
│   │   │   └── scripts/
│   │   │       └── run_research.py  # THE HANDS: Actual Python script (Tavily API)
│   │   └── journalistic-writing/
│   │       ├── SKILL.md
│   │       └── scripts/
│   │           └── write_article.py # Script that reads input file -> writes output file
│   └── tools/                # EXECUTION: The Infrastructure
│       ├── agent_factory.py  # Logic to create/spawn agents (define_new_agent)
│       └── file_ops.py       # Safe read/write implementation
└── storage/                  # THE TRUTH: Persistent memory & Workspace
    ├── agents/               # WORKFORCE: JSON configurations created by Sandy
    │   ├── zilla.json
    │   └── gonza.json
    ├── tasks/                # WORKSPACE: Active job folders
    │   └── job_101/
    │       ├── raw_data.md
    │       └── final_article.md
    └── memory/               # LONG-TERM: Projects, Todos, Logs
```

---

## 3. The Core (The Constitution)

These files define who Sandy is and how she operates. They are the first thing the LLM reads.

### AGENTS.md

**Purpose:** The operational manual. It defines the "Hybrid Model" protocols (e.g., "Never claim a task is done until you receive a success signal from a tool").

```markdown
# Operational Protocols

## Core Directive: "The Binary Truth"
1. **No Hallucination:** You must never state a task is done unless you have executed a tool and verified the output file exists.
2. **Brain vs. Hands:** You (the LLM) are the Brain. You cannot browse the web or save files. You must delegate these actions to the specific TOOLS provided.

## Delegation Logic
1. **Research Tasks:** MUST use `spawn_agent(agent="zilla", ...)`
2. **Writing Tasks:** MUST use `spawn_agent(agent="gonza", ...)`
3. **Verification:** Before answering the user, read the output file generated by the agent.
```

### TOOLS.md

**Purpose:** A strict reference guide. It lists the specific CLI commands Sandy is allowed to use. If a tool isn't listed here, Sandy knows she cannot "hallucinate" it.

```markdown
# Available Tools

## 1. Agent Management
- `spawn_agent(agent_id, task_input, output_path)`: Activates a specialized worker script.
- `define_new_agent(id, role, tools)`: Creates a new JSON configuration for a worker.

## 2. File System Operations
- `read_file(path)`: Reads content from storage.
- `write_file(path, content)`: Saves content to storage.
- `list_files(path)`: Checks if a file exists (Verification).

## 3. Web & Research
- `run_research_script(query, output_file)`: Executes the Tavily Python script directly.
```

### prompts/guard_rails.txt

**Purpose:** The "DNA" file. This text is programmatically injected into the system prompt of every new agent Sandy spawns to prevent drift.

```
*** CRITICAL SAFETY PROTOCOLS ***
1. YOU ARE RESTRICTED: You are a specialized sub-process.
2. FILE SYSTEM ONLY: You perform your task and save the result to the provided file path.
3. NO CHIT-CHAT: Do not converse. Output only the requested data or the error message.
4. SOURCE OF TRUTH: If you cannot read the input file, stop and report error.
```

---

## 4. The Skills (Specialist Capabilities)

These are modular packages. They are not agents; they are the manuals and tools the agents use.

### A. Skill: Journalistic Research

**Folder:** `src/skills/journalistic-research/`

#### SKILL.md (Metadata):

```markdown
---
name: journalistic-research
description: Use when the user needs factual, sourced information from the web.
---
# Journalistic Research Skill
This skill triggers a Python script that searches the web using the Tavily API.
It does NOT rely on LLM training data.
```

#### scripts/run_research.py (The Hands):

This script takes a query, calls the Tavily API, and saves the result. It acts as a hard rail against hallucinated search results.

```python
import sys
import os

try:
    from tavily import TavilyClient
except ImportError:
    print("ERROR: Module 'tavily' not found.")
    sys.exit(1)

def main():
    if len(sys.argv) < 3:
        print("Usage: python run_research.py <query> <output_path>")
        sys.exit(1)

    query = sys.argv[1]
    output_path = sys.argv[2]
    
    api_key = os.getenv("TAVILY_API_KEY")
    if not api_key:
        with open(output_path, "w") as f:
            f.write("ERROR: Missing TAVILY_API_KEY env var")
        sys.exit(1)

    try:
        client = TavilyClient(api_key=api_key)
        response = client.search(query=query, search_depth="advanced")
        with open(output_path, "w") as f:
            f.write(str(response))
        print(f"SUCCESS: Data saved to {output_path}")
    except Exception as e:
        with open(output_path, "w") as f:
            f.write(f"ERROR: {str(e)}")
        sys.exit(1)

if __name__ == "__main__":
    main()
```

### B. Skill: Journalistic Writing

**Folder:** `src/skills/journalistic-writing/`

#### SKILL.md:

```markdown
---
name: journalistic-writing
description: Use when transforming raw data files into readable articles.
---
# Writer Skill
This skill reads a raw text file and uses an LLM to format it.
Constraint: It has NO internet access. It can only use the input file.
```

#### scripts/write_article.py (The Hands):

```python
import sys
import os

def main():
    if len(sys.argv) < 3:
        print("Usage: python write_article.py <input_path> <output_path>")
        sys.exit(1)

    input_path = sys.argv[1]
    output_path = sys.argv[2]

    if not os.path.exists(input_path):
        print(f"ERROR: Input file {input_path} does not exist.")
        sys.exit(1)
    
    with open(input_path, "r") as f:
        raw_data = f.read()

    # In production, this calls the LLM API strictly constrained to the input
    article_content = "# Generated Article\n\n" + raw_data[:100] + "..."

    with open(output_path, "w") as f:
        f.write(article_content)

    print(f"SUCCESS: Article written to {output_path}")

if __name__ == "__main__":
    main()
```

---

## 5. The Infrastructure (Tools)

### src/tools/agent_factory.py

**Purpose:** Allows Sandy to create new agents safely by writing JSON configurations, enforcing that only valid tools are assigned.

```python
import json
import os

AGENTS_DIR = "./storage/agents"

def define_new_agent(agent_id, role, allowed_tools):
    valid_tools = ["run_research_script", "write_file", "read_file"]
    
    # Anti-Hallucination: Filter out tools that don't exist
    safe_tools = [t for t in allowed_tools if t in valid_tools]
    
    config = {
        "id": agent_id,
        "role": role,
        "tools": safe_tools
    }
    
    os.makedirs(AGENTS_DIR, exist_ok=True)
    path = os.path.join(AGENTS_DIR, f"{agent_id}.json")
    
    with open(path, "w") as f:
        json.dump(config, f, indent=2)
    return f"Agent {agent_id} created at {path}"
```

---

## 6. The Agents (Configuration)

These are JSON configurations stored in `storage/agents/`. They are not code; they are "Job Descriptions" created by Sandy.

### Example: zilla.json

```json
{
  "id": "zilla",
  "role": "Journalistic Researcher",
  "tools": [
    "run_research_script",
    "write_file"
  ],
  "note": "This agent CANNOT write articles. It can only find facts."
}
```

---

## 7. The Workflow (Step-by-Step Execution)

Here is how the system processes a request like: "Sandy, research AI news and write a report."

### The Brain (Sandy):
- Reads TOOLS.md and sees she has `spawn_agent`.
- Reads skills/ metadata and identifies the journalistic-research skill.
- Decides to activate the agent Zilla.

### The Handover (Execution):
- Sandy runs: `spawn_agent(agent="zilla", task="AI news", output="storage/tasks/job_1/raw.md")`.
- The System loads `zilla.json` + injects `guard_rails.txt`.
- Zilla (restricted environment) executes `scripts/run_research.py`.
- The Script (not the AI) fetches data and saves it to `raw.md`.

### The Truth (Verification):
- The system verifies that `raw.md` exists on the disk.

### The Handoff:
- Sandy activates Gonza.
- Instruction: "Read raw.md. Write final.md."
- Gonza has no internet access. She can only read the file provided. She writes the report.

### The Report:
- Sandy responds to user: "Done. The report is saved here: storage/tasks/job_1/final.md."

---

## Key Principles

1. **No Tool, No Action:** Sandy cannot claim a task is done without tool execution
2. **File System is Truth:** All state changes must be verified on disk
3. **Hardcoded Scripts:** Skills use deterministic Python/Bash scripts, not LLM prompts
4. **Restricted Agents:** Each agent has limited tool access enforced by configuration
5. **Guard Rails:** Safety protocols injected into every spawned agent
6. **Verification Required:** Output files must exist before Sandy reports success
