#!/bin/bash
# Sandy CLI Helper for Raspberry Pi
# Usage: Just type 'sandy' in terminal

show_help() {
    cat << 'SANDY_HELP'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   ğŸ§  SANDY QUICK REFERENCE                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“± ACCESS SANDY:
  Telegram:     @sandy_adhd_coach_bot
  Web UI:       http://100.72.180.20:3000 (via Tailscale)

ğŸ“Š CHECK STATUS:
  sandy status      - Check if Sandy is running
  sandy logs        - View real-time logs
  sandy update      - Force check for updates

ğŸ”§ MANAGE SANDY:
  sandy start       - Start Sandy (if not running)
  sandy stop        - Stop Sandy
  sandy restart     - Restart Sandy

ğŸ“ LOCATIONS:
  Sandy Code:     ~/sandy/
  Data Files:     ~/sandy/sandy.data/
  User Files:     /mnt/storage/
  Logs:           ~/sandy/sandy.data/runtime/logs/

ğŸ“ KEY LOG FILES:
  Sandy Runtime:  ~/sandy/sandy.data/runtime/logs/microclaw-YYYY-MM-DD-HH.log
  Activity:       ~/sandy/soul/data/runtime/activity_log.json

ğŸ”„ AUTO-UPDATE:
  Status:         ps aux | grep sandy
  Config:         crontab -l | grep sandy

ğŸ’¡ QUICK TIPS:
  â€¢ Sandy checks GitHub every 5 minutes for updates
  â€¢ Auto-restarts if she crashes
  â€¢ Auto-starts on boot (via crontab)
  â€¢ Use Ctrl+C to exit log view

For more help: ~/sandy/QUICK_DEPLOY.md

SANDY_HELP
}

# Command handling
case "${1:-help}" in
    status|s)
        echo "Checking Sandy status..."
        if pgrep -f "microclaw start" > /dev/null; then
            echo "âœ… Sandy is running"
            echo ""
            echo "Process info:"
            ps aux | grep -E "(microclaw|watchdog)" | grep -v grep
            echo ""
            echo "Uptime:"
            ps -o pid,etime,command -p $(pgrep -f "microclaw start")
        else
            echo "âŒ Sandy is NOT running"
            echo "Start with: sandy start"
        fi
        ;;
    
    logs|log|l)
        echo "ğŸ“Š Showing Sandy logs (Ctrl+C to exit)..."
        echo ""
        
        # Find the actual Sandy runtime logs directory
        SANDY_LOG_DIR="$HOME/sandy/sandy.data/runtime/logs"
        
        if [ -d "$SANDY_LOG_DIR" ]; then
            # Find the most recent log file
            LATEST_LOG=$(ls -t "$SANDY_LOG_DIR"/microclaw-*.log 2>/dev/null | head -1)
            if [ -f "$LATEST_LOG" ]; then
                echo "=== Sandy Runtime Logs: $(basename $LATEST_LOG) ==="
                tail -n 50 -f "$LATEST_LOG" 2>/dev/null &
                TAIL_PID=$!
                sleep 0.5
                read -p "Press Enter to stop viewing..."
                kill $TAIL_PID 2>/dev/null
            else
                echo "No log files found in $SANDY_LOG_DIR"
                echo "Sandy may not have started logging yet."
            fi
        else
            echo "No logs found yet."
            echo "Expected location: $SANDY_LOG_DIR"
            echo "Logs will appear after Sandy starts and processes activity."
        fi
        ;;
    
    start)
        echo "ğŸš€ Starting Sandy..."
        if pgrep -f "microclaw start" > /dev/null; then
            echo "Sandy is already running!"
            sandy status
        else
            cd ~/sandy
            mkdir -p logs
            nohup ./target/release/microclaw start > logs/sandy.log 2>&1 &
            sleep 2
            echo "âœ… Sandy started"
            sandy status
        fi
        ;;
    
    stop)
        echo "ğŸ›‘ Stopping Sandy..."
        pkill -f "microclaw start"
        echo "âœ… Sandy stopped"
        ;;
    
    restart)
        echo "ğŸ”„ Restarting Sandy..."
        sandy stop
        sleep 2
        sandy start
        ;;
    
    update|u)
        echo "ğŸ”„ Checking for updates..."
        cd ~/sandy
        git fetch origin main
        LOCAL=$(git rev-parse HEAD)
        REMOTE=$(git rev-parse origin/main)
        
        if [ "$LOCAL" != "$REMOTE" ]; then
            echo "ğŸ“¥ Updates available! Pulling..."
            git pull origin main
            echo "ğŸ”¨ Rebuilding..."
            cargo build --release
            echo "âœ… Update complete! Restarting..."
            sandy restart
        else
            echo "âœ… Already up to date"
        fi
        ;;
    
    edit-config|config)
        echo "âš™ï¸  Opening config file..."
        nano ~/sandy/sandy.config.yaml
        ;;
    
    web|w)
        echo "ğŸŒ Sandy Web UI:"
        echo "  Local:     http://localhost:3000"
        echo "  Tailscale: http://100.72.180.20:3000"
        echo ""
        echo "Opening in browser..."
        xdg-open http://localhost:3000 2>/dev/null || \
        sensible-browser http://localhost:3000 2>/dev/null || \
        echo "Please open: http://localhost:3000"
        ;;
    
    storage|files)
        echo "ğŸ“ User files location: /mnt/storage/"
        ls -la /mnt/storage/
        ;;
    
    help|--help|-h|*)
        show_help
        ;;
esac
